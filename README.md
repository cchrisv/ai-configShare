# Autonomous Ticket Workflow

Azure DevOps and Salesforce workflow automation with AI assistant integration (GitHub Copilot, Cursor, or other agents that support file references).

## Quick Start

Run the setup prompt in your AI chat:

```
/util-setup
```

This walks you through prerequisite checks, dependency installation, authentication (Azure DevOps + Salesforce), and validation. Once complete, run `/ticket-grooming-phase-01-research` with a work item ID to start a workflow.

## Architecture

```
.github/
├── prompts/              # Phase and utility prompts (ticket-grooming-phase-*.prompt.md, util-*.prompt.md)
└── copilot-instructions.md

config/                   # Configuration files
├── shared.json           # Master configuration
├── templates/            # Work item and documentation templates
└── standards/            # Development standards, architecture reference, org dictionary

scripts/workflow/         # TypeScript CLI tools
├── cli/                  # CLI entry points (workflow-tools, ado-tools, sf-tools, wiki-tools, report-tools, team-tools)
├── src/                  # Source code
└── dist/                 # Compiled output (generated by npm run build)
```

Runtime artifacts are stored in `.ai-artifacts/<work_item_id>/ticket-context.json` — a single unified context file (Context7 pattern) that progressively grows through phases. Feature research artifacts are stored in `.ai-artifacts/sf-research/<feature-name>/`.

## Prompts

### Utility Prompts

- `util-help.prompt.md` - Overview of all prompts and system architecture
- `util-setup.prompt.md` - First-time setup guide
- `util-activity-report.prompt.md` - Generate CSV activity reports
- `util-apply-template.prompt.md` - Re-apply rich HTML templates to an ADO work item or wiki page (formatting only, no content changes). Supports User Story, Bug, and Feature types, plus three wiki page types (work item, feature solution design, general).
- `util-sequence-tickets.prompt.md` - Analyze dependencies among child work items under a Feature or Epic, recommend execution order, and create predecessor/successor links in ADO
- `util-team-members.prompt.md` - Discover team members from Microsoft Graph (Azure AD / Entra ID) org hierarchy
- `util-update-feature-progress.prompt.md` - Analyze a Feature's descendant work items and update its Progress, Planned Work, and Blockers fields with evidence-based HTML using flow health detection (stalled work, assignment churn, silent work, cascade risks)
- `util-morning-checkin.prompt.md` - Generate narrative-rich content for the Teams Updates app Morning Check-In. Queries ADO activity for the previous day, runs a health check on assigned work (stalled, silent, aging New items), asks standup questions (priorities via ticket IDs, blockers, flags), enriches with ADO context, and outputs copy-paste-ready text for 3 form fields
- `util-activity-briefing.prompt.md` - Generate manager activity briefings organized around five questions: what moved, what decisions were made, what value was delivered, is progress at risk, and what decisions are needed. Evidence-cited narratives with coaching tone
- `util-grooming-update.prompt.md` - Iterative requirements/scope updates during development (what & why only)
- `util-solutioning-update.prompt.md` - Iterative solution design updates during development (how only)
- `util-groom-feature.prompt.md` - Refine a Feature work item by populating Description, Business Value, Objectives, and Acceptance Criteria fields with evidence-based content from grooming research and child work items

Supporting/shared: `util-base.prompt.md`, `util-research-base.prompt.md`

### Ticket Grooming Process

- `ticket-grooming-phase-01-research.prompt.md` - Initialize workflow + business research (org dictionary, ADO, wiki, business context)
- `ticket-grooming-phase-02-grooming.prompt.md` - Requirements refinement (what & why), template-driven ADO field updates
- `ticket-grooming-phase-03-solutioning-research.prompt.md` - Technical research (Salesforce metadata, dependencies, standards compliance)
- `ticket-grooming-phase-04-solutioning.prompt.md` - Solution design (how), template-driven ADO field updates
- `ticket-grooming-phase-05-finalization.prompt.md` - WSJF scoring, ADO links, final field updates
- `ticket-grooming-phase-06-dev-closeout.prompt.md` - Full closeout: planned vs actual, release notes, ADO updates
- `util-feature-solution-design.prompt.md` - Aggregate child work items into solution design document (Feature or Epic level)

Use `util-repeat-phase.prompt.md` to re-run any individual phase.

**Standalone utilities:** `util-grooming-update` and `util-solutioning-update` run independently — they fetch the current ticket directly from ADO and do not require local artifacts from prior phases. Grooming update handles requirements (what & why), solutioning update handles solution design (how). Phase 06 (dev closeout) also runs independently to reconcile planned vs actual with release notes.

### Feature Grooming Process

A standalone multi-phase workflow to comprehensively research and document existing Salesforce functionality as a factual current-state reference. Not tied to the ticket lifecycle -- accepts a Salesforce object name, an ADO work item ID, or both as input. Outputs a local research artifact and publishes a wiki page.

All output is strictly factual -- the pipeline documents what exists and how it works without opinions, quality assessments, risk ratings, compliance scores, or recommendations.

```
Phase 01 → Phase 02 → Phase 03a → Phase 03b → Phase 03c → Phase 03d → Phase 05
Initialize   ADO        SF Schema   SF Auto     Execution     SF Platform  Documentation
```

- `feature-research-phase-01-initialize.prompt.md` - Resolve input (SF object names or ADO ID), validate auth, establish research scope and mission anchor
- `feature-research-phase-02-ado-discovery.prompt.md` - Discover related ADO work items, mine comments, search wiki for existing documentation
- `feature-research-phase-03a-sf-schema.prompt.md` - Document object model: fields, relationships, record types, PII detection, field-level metadata
- `feature-research-phase-03b-sf-automation.prompt.md` - Broad discovery of triggers, flows, Apex, LWC, Aura with relevance filtering; build dependency graph
- `feature-research-phase-03c-sf-architecture.prompt.md` - Map order of operations, execution chains, cross-object cascades, transaction boundaries, component layer map
- `feature-research-phase-03d-sf-platform.prompt.md` - Document security model, integrations, platform events, data volumes
- `feature-research-phase-05-documentation.prompt.md` - Generate 10-section factual research report with mermaid diagrams; publish to ADO Wiki

Artifacts are stored in `.ai-artifacts/sf-research/<feature-name>/` with a shared `research-context.json` (Context7 pattern) across all phases.

## CLI Tools

All commands support `--json` for structured output and `-v` for verbose logging.

**Important:** Commands are defined in `config/shared.json` under `cli_commands`. Use template variables like `{{cli.ado_get}}` in prompts.

### Quick Reference

```bash
npx --prefix scripts/workflow workflow-tools prepare -w <id> --json
npx --prefix scripts/workflow workflow-tools status -w <id> --json
npx --prefix scripts/workflow ado-tools get <id> --json
npx --prefix scripts/workflow sf-tools query "<SOQL>" --json
npx --prefix scripts/workflow wiki-tools search "<term>" --json
npx --prefix scripts/workflow report-tools activity -p "Name|email@domain.com" -d 30 --json
npx --prefix scripts/workflow team-tools discover --leader <email> --json
```

### workflow-tools

Workflow lifecycle management.

```bash
# Initialize workflow for a work item
npx --prefix scripts/workflow workflow-tools prepare -w <id> [--force] [--json]

# Check workflow status
npx --prefix scripts/workflow workflow-tools status -w <id> [--json]

# Reset specific phase (clears artifacts, updates run-state)
npx --prefix scripts/workflow workflow-tools reset -w <id> --phase <phase> --force [--json]

# Reset entire workflow (deletes all artifacts)
npx --prefix scripts/workflow workflow-tools reset -w <id> --force [--json]
```

**Valid phases:** `research`, `grooming`, `solutioning`, `finalization`, `dev_updates`, `closeout`

### ado-tools

Azure DevOps work item operations.

```bash
# Get work item
npx --prefix scripts/workflow ado-tools get <id> [--expand All|Relations|Fields] [--comments] [--json]

# Update work item - Basic fields
npx --prefix scripts/workflow ado-tools update <id> --title "New Title" [--json]
npx --prefix scripts/workflow ado-tools update <id> --description "<html>" [--json]
npx --prefix scripts/workflow ado-tools update <id> --state "Active" [--json]
npx --prefix scripts/workflow ado-tools update <id> --tags "Tag1; Tag2" [--json]

# Update work item - Acceptance criteria
npx --prefix scripts/workflow ado-tools update <id> --ac "<html>" [--json]
npx --prefix scripts/workflow ado-tools update <id> --acceptance-criteria "<html>" [--json]

# Update work item - Bug fields
npx --prefix scripts/workflow ado-tools update <id> --repro-steps "<html>" [--json]
npx --prefix scripts/workflow ado-tools update <id> --system-info "<html>" [--json]

# Update work item - Numeric/picklist fields
npx --prefix scripts/workflow ado-tools update <id> --story-points 5 [--json]
npx --prefix scripts/workflow ado-tools update <id> --priority 2 [--json]
npx --prefix scripts/workflow ado-tools update <id> --work-class "Development" [--json]
npx --prefix scripts/workflow ado-tools update <id> --requires-qa "Yes" [--json]

# Update work item - File-based content (for large HTML)
npx --prefix scripts/workflow ado-tools update <id> --description-file ./description.html [--json]
npx --prefix scripts/workflow ado-tools update <id> --ac-file ./acceptance-criteria.html [--json]
npx --prefix scripts/workflow ado-tools update <id> --repro-steps-file ./repro.html [--json]
npx --prefix scripts/workflow ado-tools update <id> --system-info-file ./sysinfo.html [--json]

# Update work item - Arbitrary field
npx --prefix scripts/workflow ado-tools update <id> --field "Custom.TechnicalNotes" --value "Notes" [--json]
npx --prefix scripts/workflow ado-tools update <id> --field "Custom.SFComponents" --value-file ./components.txt [--json]

# Update work item - Bulk from JSON file (grooming-result.json)
npx --prefix scripts/workflow ado-tools update <id> --fields-file "./grooming/grooming-result.json" [--json]

# Update work item - Add comment
npx --prefix scripts/workflow ado-tools update <id> --comment "Status update here" [--json]

# Create work item
npx --prefix scripts/workflow ado-tools create <type> --title "<title>" [--parent <id>] [--json]

# Search work items (WIQL)
npx --prefix scripts/workflow ado-tools search --wiql "<wiql>" [--json]
npx --prefix scripts/workflow ado-tools search --text "keyword" --type "User Story" [--json]

# Get relations/links
npx --prefix scripts/workflow ado-tools relations <id> [--json]

# Link work items
npx --prefix scripts/workflow ado-tools link <sourceId> <targetId> --type <relationType> [--json]

# Unlink work items
npx --prefix scripts/workflow ado-tools unlink <sourceId> <targetId> --type <relationType> [--json]
```

**Supported Update Parameters:**

| Parameter | Field Path | Description |
|-----------|------------|-------------|
| `--title` | `System.Title` | Work item title |
| `--description` | `System.Description` | Description (HTML) |
| `--state` | `System.State` | State (New, Active, etc.) |
| `--tags` | `System.Tags` | Tags (semicolon-separated) |
| `--ac`, `--acceptance-criteria` | `Microsoft.VSTS.Common.AcceptanceCriteria` | Acceptance criteria (HTML) |
| `--repro-steps` | `Microsoft.VSTS.TCM.ReproSteps` | Bug repro steps (HTML) |
| `--system-info` | `Microsoft.VSTS.TCM.SystemInfo` | Bug system info (HTML) |
| `--story-points` | `Microsoft.VSTS.Scheduling.StoryPoints` | Story points |
| `--priority` | `Microsoft.VSTS.Common.Priority` | Priority (1-4) |
| `--work-class` | `Custom.WorkClassType` | Work class type |
| `--requires-qa` | `Custom.RequiresQA` | Requires QA (Yes/No) |
| `--field` + `--value` | Any field path | Arbitrary field update |
| `--fields-file` | Multiple fields | Bulk update from JSON |

### sf-tools

Salesforce query and metadata operations.

```bash
# Execute SOQL query
npx --prefix scripts/workflow sf-tools query "<soql>" [--tooling] [--json]

# Describe object/metadata
npx --prefix scripts/workflow sf-tools describe <objectName> [--json]

# Discover dependencies
npx --prefix scripts/workflow sf-tools discover <componentName> [--depth <n>] [--json]

# List Apex classes
npx --prefix scripts/workflow sf-tools apex-classes [--json]

# List Apex triggers
npx --prefix scripts/workflow sf-tools apex-triggers [--json]

# List flows
npx --prefix scripts/workflow sf-tools flows [--json]

# List validation rules
npx --prefix scripts/workflow sf-tools validation-rules <objectName> [--json]
```

### wiki-tools

Azure DevOps wiki operations.

```bash
# Get wiki page (by path or page ID)
npx --prefix scripts/workflow wiki-tools get <pagePath> [--json]
npx --prefix scripts/workflow wiki-tools get --page-id <pageId> [--json]

# Create/update wiki page (by path or page ID)
npx --prefix scripts/workflow wiki-tools update <pagePath> --content "<content>" [--json]
npx --prefix scripts/workflow wiki-tools update --page-id <pageId> --content "<content>" [--json]
npx --prefix scripts/workflow wiki-tools create <pagePath> --content "<content>" [--json]

# Search wiki
npx --prefix scripts/workflow wiki-tools search "<query>" [--json]

# List wiki pages
npx --prefix scripts/workflow wiki-tools list [--path <basePath>] [--json]

# Delete wiki page
npx --prefix scripts/workflow wiki-tools delete <pagePath> [--json]
```

### report-tools

Azure DevOps activity report generation.

```bash
# Generate activity report for specified users
npx --prefix scripts/workflow report-tools activity -p "Name|email@domain.com" [-p "Name2|email2@domain.com" ...] [options] [--json]

# Options
#   -d, --days <days>       Number of days to look back (default: 30)
#   -o, --output <dir>      Output directory (default: .ai-artifacts/reports)
#   --no-wiki               Exclude wiki activities
#   --no-prs                Exclude pull request activities
#   --fast                  Fast mode (~20s) - only direct activity
#   -q, --quiet             Minimal output
#   -v, --verbose           Verbose/debug output
```

**Important:** People are specified as `"Display Name|email@domain.com"`. Multiple `-p` values can be passed. Reports are written as CSV under the output directory.

### team-tools

Microsoft Graph team member discovery.

```bash
# Discover team members (you-centric: your manager, peers, subordinates)
npx --prefix scripts/workflow team-tools discover [--json]

# Discover team members under a specific leader (team-centric)
npx --prefix scripts/workflow team-tools discover --leader <email> [--json]

# Include department members
npx --prefix scripts/workflow team-tools discover --department [--json]

# Enrich with Salesforce user data
npx --prefix scripts/workflow team-tools discover --salesforce [--json]

# Export as CSV and/or Markdown (with Mermaid org chart)
npx --prefix scripts/workflow team-tools discover --leader <email> --csv --markdown [--json]

# Options
#   -l, --leader <email>    Root tree at this leader (deterministic, team-centric)
#   -d, --department        Include all members of your department
#   -s, --salesforce        Enrich with Salesforce user data (profile, role, username)
#   --csv                   Export results as CSV
#   --markdown              Export results as Markdown with Mermaid org chart
#   -o, --output <dir>      Output directory (default: .ai-artifacts/reports)
#   -q, --quiet             Minimal output
#   -v, --verbose           Verbose/debug output
```

**Modes:**
- **Without `--leader`** — you-centric: discovers your manager, peers, and subordinates.
- **With `--leader`** — team-centric: discovers everyone under the leader; anyone on the team gets the same deterministic result.

## Authentication

### Azure DevOps

Uses Azure CLI. No PAT tokens required.

```bash
az login
az account show
```

### Salesforce

Uses SF CLI authentication.

```bash
sf org login web -a production
sf org list
```

## Configuration

All paths, CLI commands, and settings are in `config/shared.json`.

Use template variables in prompts:
- `{{cli.workflow_prepare}}` - Initialize workflow
- `{{cli.ado_get}}` - Get ADO work item
- `{{cli.sf_query}}` - Run SOQL query
- `{{cli.report_activity}}` - Generate activity report
- `{{cli.team_discover}}` - Discover team members
- `{{paths.artifacts_root}}` - Artifacts directory

## Development

```bash
cd scripts/workflow
npm install      # Install dependencies
npm run build    # Build TypeScript (tsup)
npm test         # Run tests (vitest)
npm run lint    # Lint code
```

Root `package.json` includes Salesforce DX tooling, Prettier, Husky, and lint-staged for the repo.

## Documentation

- [Configuration](config/shared.json)
- [Copilot Instructions](.github/copilot-instructions.md)
