# Autonomous Ticket Workflow

Azure DevOps and Salesforce workflow automation with AI assistant integration (GitHub Copilot, Cursor, or other agents that support file references).

## Quick Start

Run the setup prompt in your AI chat:

```
/util-setup
```

This walks you through prerequisite checks, dependency installation, authentication (Azure DevOps + Salesforce), and validation. Once complete, run `/phase-01-prepare-ticket` with a work item ID to start a workflow.

## Architecture

```
.github/
├── prompts/              # Phase and utility prompts (phase-XX-*.prompt.md, util-*.prompt.md)
└── copilot-instructions.md

config/                   # Configuration files
├── shared.json           # Master configuration
├── organization-dictionary.json
├── templates/            # Work item and documentation templates
└── standards/            # Development standards

scripts/workflow/         # TypeScript CLI tools
├── cli/                  # CLI entry points (workflow-tools, ado-tools, sf-tools, wiki-tools, report-tools)
├── src/                  # Source code
└── dist/                 # Compiled output (generated by npm run build)
```

Runtime artifacts are stored in `.ai-artifacts/<work_item_id>/` (research, grooming, solutioning, wiki, finalization; dev-updates when using phase-08a/08b, closeout when using phase-09, solution-design when using phase-10, sequencing when using util-sequence-tickets).

## Prompts

### Utility Prompts

- `util-help.prompt.md` - Overview of all prompts and system architecture
- `util-setup.prompt.md` - First-time setup guide
- `util-activity-report.prompt.md` - Generate CSV activity reports
- `util-reformat-ticket.prompt.md` - Re-apply rich HTML templates to an ADO work item or wiki page (formatting only, no content changes). Supports User Story, Bug, and Feature types, plus three wiki page types (work item, feature solution design, general).
- `util-sequence-tickets.prompt.md` - Analyze dependencies among child work items under a Feature or Epic, recommend execution order, and create predecessor/successor links in ADO

Supporting/shared: `util-base.prompt.md`, `util-research-base.prompt.md`, `util-subagent-research.prompt.md`, `util-subagent-sf-discovery.prompt.md`

### Full Workflow

- `phase-01-prepare-ticket.prompt.md` - Runs the entire lifecycle: initialize → research → grooming → solutioning → wiki → finalization
- `phase-02-initialize.prompt.md` - Initializes artifact folder structure

Research can be run in parallel for faster runs: `phase-03-research-parallel.prompt.md`; Salesforce research has a parallel variant: `phase-03e-research-salesforce-parallel.prompt.md`.

### Phase Prompts

| Phase | Prompt | Purpose |
|-------|--------|---------|
| Research | `phase-03-research.prompt.md` | Multi-source research (ADO, wiki, Salesforce, code, web) |
| Grooming | `phase-04-grooming.prompt.md` | Requirements refinement (what & why) |
| Solutioning | `phase-05-solutioning.prompt.md` | Solution design (how) |
| Wiki | `phase-06-wiki.prompt.md` | Wiki documentation creation |
| Finalization | `phase-07-finalization.prompt.md` | Final validation and ADO update |
| Dev Update — Grooming | `phase-08a-dev-update-grooming.prompt.md` | Iterative requirements/scope updates (what & why) |
| Dev Update — Solutioning | `phase-08b-dev-update-solutioning.prompt.md` | Iterative solution design updates (how) |
| Dev Closeout | `phase-09-dev-closeout.prompt.md` | Full closeout: planned vs actual, release notes, ADO + wiki |
| Feature Solution Design | `phase-10-feature-solution-design.prompt.md` | Aggregate child work items into solution design document and wiki page |

Use `re-phase.prompt.md` to re-run any individual phase (03-07) with existing artifacts.

#### Development Phases (08a, 08b, 09)

Phases 08a, 08b, and 09 are designed to run **standalone** — they do not require local artifact files from prior grooming/solutioning phases. They fetch the current ticket and wiki directly from ADO and gather evidence from pull requests, Salesforce audit trail, and metadata to produce accurate updates.

- **Phase 08a (What & Why):** Updates Description, Acceptance Criteria, Tags, and classification. Enforces requirements-only content — no implementation detail.
- **Phase 08b (How):** Updates DevelopmentSummary and SFComponents. Enforces solution-only content — architecture, components, technical approach.
- **Phase 09 (Closeout):** Reconciles planned vs. actual using evidence, resolves all assumptions and unknowns, generates release notes (`Custom.ReleaseNotes`), updates wiki with end-to-end flow and previous state vs current state documentation, and tags with `Dev-Complete`.

#### Feature / Epic-Level Phases (10)

- **Phase 10 (Feature Solution Design):** Run at the Feature or Epic level after all child user stories have been groomed and solutioned. Supports Feature (1-level: Feature → User Stories) and Epic (2-level: Epic → Features → User Stories) hierarchies. Aggregates child work item data from ADO and wiki to generate a comprehensive solution design document covering end-to-end current state, future state, and solution architecture. Produces a local artifact and publishes a wiki page under `/Features/` or `/Epics/`.

### Research Sub-Prompts (Phase 03)

- `phase-03a-research-organization-dictionary.prompt.md` - Organization terminology
- `phase-03b-research-ado.prompt.md` - Azure DevOps work items
- `phase-03c-research-wiki.prompt.md` - Internal wiki content
- `phase-03d-research-business-context.prompt.md` - Business problem analysis
- `phase-03e-research-salesforce.prompt.md` - Salesforce metadata (parallel: `phase-03e-research-salesforce-parallel.prompt.md`)
- `phase-03f-research-similar-workitems.prompt.md` - Related work items
- `phase-03g-research-code.prompt.md` - Codebase analysis
- `phase-03h-research-web.prompt.md` - Web best practices
- `phase-03z-research-synthesis.prompt.md` - Analysis synthesis

## CLI Tools

All commands support `--json` for structured output and `-v` for verbose logging.

**Important:** Commands are defined in `config/shared.json` under `cli_commands`. Use template variables like `{{cli.ado_get}}` in prompts.

### Quick Reference

```bash
npx --prefix scripts/workflow workflow-tools prepare -w <id> --json
npx --prefix scripts/workflow workflow-tools status -w <id> --json
npx --prefix scripts/workflow ado-tools get <id> --json
npx --prefix scripts/workflow sf-tools query "<SOQL>" --json
npx --prefix scripts/workflow wiki-tools search "<term>" --json
npx --prefix scripts/workflow report-tools activity -p "Name|email@domain.com" -d 30 --json
```

### workflow-tools

Workflow lifecycle management.

```bash
# Initialize workflow for a work item
npx --prefix scripts/workflow workflow-tools prepare -w <id> [--force] [--json]

# Check workflow status
npx --prefix scripts/workflow workflow-tools status -w <id> [--json]

# Reset specific phase (clears artifacts, updates run-state)
npx --prefix scripts/workflow workflow-tools reset -w <id> --phase <phase> --force [--json]

# Reset entire workflow (deletes all artifacts)
npx --prefix scripts/workflow workflow-tools reset -w <id> --force [--json]
```

**Valid phases:** `research`, `grooming`, `solutioning`, `wiki`

### ado-tools

Azure DevOps work item operations.

```bash
# Get work item
npx --prefix scripts/workflow ado-tools get <id> [--expand All|Relations|Fields] [--comments] [--json]

# Update work item - Basic fields
npx --prefix scripts/workflow ado-tools update <id> --title "New Title" [--json]
npx --prefix scripts/workflow ado-tools update <id> --description "<html>" [--json]
npx --prefix scripts/workflow ado-tools update <id> --state "Active" [--json]
npx --prefix scripts/workflow ado-tools update <id> --tags "Tag1; Tag2" [--json]

# Update work item - Acceptance criteria
npx --prefix scripts/workflow ado-tools update <id> --ac "<html>" [--json]
npx --prefix scripts/workflow ado-tools update <id> --acceptance-criteria "<html>" [--json]

# Update work item - Bug fields
npx --prefix scripts/workflow ado-tools update <id> --repro-steps "<html>" [--json]
npx --prefix scripts/workflow ado-tools update <id> --system-info "<html>" [--json]

# Update work item - Numeric/picklist fields
npx --prefix scripts/workflow ado-tools update <id> --story-points 5 [--json]
npx --prefix scripts/workflow ado-tools update <id> --priority 2 [--json]
npx --prefix scripts/workflow ado-tools update <id> --work-class "Development" [--json]
npx --prefix scripts/workflow ado-tools update <id> --requires-qa "Yes" [--json]

# Update work item - File-based content (for large HTML)
npx --prefix scripts/workflow ado-tools update <id> --description-file ./description.html [--json]
npx --prefix scripts/workflow ado-tools update <id> --ac-file ./acceptance-criteria.html [--json]
npx --prefix scripts/workflow ado-tools update <id> --repro-steps-file ./repro.html [--json]
npx --prefix scripts/workflow ado-tools update <id> --system-info-file ./sysinfo.html [--json]

# Update work item - Arbitrary field
npx --prefix scripts/workflow ado-tools update <id> --field "Custom.TechnicalNotes" --value "Notes" [--json]
npx --prefix scripts/workflow ado-tools update <id> --field "Custom.SFComponents" --value-file ./components.txt [--json]

# Update work item - Bulk from JSON file (grooming-result.json)
npx --prefix scripts/workflow ado-tools update <id> --fields-file "./grooming/grooming-result.json" [--json]

# Update work item - Add comment
npx --prefix scripts/workflow ado-tools update <id> --comment "Status update here" [--json]

# Create work item
npx --prefix scripts/workflow ado-tools create <type> --title "<title>" [--parent <id>] [--json]

# Search work items (WIQL)
npx --prefix scripts/workflow ado-tools search --wiql "<wiql>" [--json]
npx --prefix scripts/workflow ado-tools search --text "keyword" --type "User Story" [--json]

# Get relations/links
npx --prefix scripts/workflow ado-tools relations <id> [--json]

# Link work items
npx --prefix scripts/workflow ado-tools link <sourceId> <targetId> --type <relationType> [--json]

# Unlink work items
npx --prefix scripts/workflow ado-tools unlink <sourceId> <targetId> --type <relationType> [--json]
```

**Supported Update Parameters:**

| Parameter | Field Path | Description |
|-----------|------------|-------------|
| `--title` | `System.Title` | Work item title |
| `--description` | `System.Description` | Description (HTML) |
| `--state` | `System.State` | State (New, Active, etc.) |
| `--tags` | `System.Tags` | Tags (semicolon-separated) |
| `--ac`, `--acceptance-criteria` | `Microsoft.VSTS.Common.AcceptanceCriteria` | Acceptance criteria (HTML) |
| `--repro-steps` | `Microsoft.VSTS.TCM.ReproSteps` | Bug repro steps (HTML) |
| `--system-info` | `Microsoft.VSTS.TCM.SystemInfo` | Bug system info (HTML) |
| `--story-points` | `Microsoft.VSTS.Scheduling.StoryPoints` | Story points |
| `--priority` | `Microsoft.VSTS.Common.Priority` | Priority (1-4) |
| `--work-class` | `Custom.WorkClassType` | Work class type |
| `--requires-qa` | `Custom.RequiresQA` | Requires QA (Yes/No) |
| `--field` + `--value` | Any field path | Arbitrary field update |
| `--fields-file` | Multiple fields | Bulk update from JSON |

### sf-tools

Salesforce query and metadata operations.

```bash
# Execute SOQL query
npx --prefix scripts/workflow sf-tools query "<soql>" [--tooling] [--json]

# Describe object/metadata
npx --prefix scripts/workflow sf-tools describe <objectName> [--json]

# Discover dependencies
npx --prefix scripts/workflow sf-tools discover <componentName> [--depth <n>] [--json]

# List Apex classes
npx --prefix scripts/workflow sf-tools apex-classes [--json]

# List Apex triggers
npx --prefix scripts/workflow sf-tools apex-triggers [--json]

# List flows
npx --prefix scripts/workflow sf-tools flows [--json]

# List validation rules
npx --prefix scripts/workflow sf-tools validation-rules <objectName> [--json]
```

### wiki-tools

Azure DevOps wiki operations.

```bash
# Get wiki page (by path or page ID)
npx --prefix scripts/workflow wiki-tools get <pagePath> [--json]
npx --prefix scripts/workflow wiki-tools get --page-id <pageId> [--json]

# Create/update wiki page (by path or page ID)
npx --prefix scripts/workflow wiki-tools update <pagePath> --content "<content>" [--json]
npx --prefix scripts/workflow wiki-tools update --page-id <pageId> --content "<content>" [--json]
npx --prefix scripts/workflow wiki-tools create <pagePath> --content "<content>" [--json]

# Search wiki
npx --prefix scripts/workflow wiki-tools search "<query>" [--json]

# List wiki pages
npx --prefix scripts/workflow wiki-tools list [--path <basePath>] [--json]

# Delete wiki page
npx --prefix scripts/workflow wiki-tools delete <pagePath> [--json]
```

### report-tools

Azure DevOps activity report generation.

```bash
# Generate activity report for specified users
npx --prefix scripts/workflow report-tools activity -p "Name|email@domain.com" [-p "Name2|email2@domain.com" ...] [options] [--json]

# Options
#   -d, --days <days>       Number of days to look back (default: 30)
#   -o, --output <dir>      Output directory (default: .ai-artifacts/reports)
#   --no-wiki               Exclude wiki activities
#   --no-prs                Exclude pull request activities
#   --fast                  Fast mode (~20s) - only direct activity
#   -q, --quiet             Minimal output
#   -v, --verbose           Verbose/debug output
```

**Important:** People are specified as `"Display Name|email@domain.com"`. Multiple `-p` values can be passed. Reports are written as CSV under the output directory.

## Authentication

### Azure DevOps

Uses Azure CLI. No PAT tokens required.

```bash
az login
az account show
```

### Salesforce

Uses SF CLI authentication.

```bash
sf org login web -a production
sf org list
```

## Configuration

All paths, CLI commands, and settings are in `config/shared.json`.

Use template variables in prompts:
- `{{cli.workflow_prepare}}` - Initialize workflow
- `{{cli.ado_get}}` - Get ADO work item
- `{{cli.sf_query}}` - Run SOQL query
- `{{cli.report_activity}}` - Generate activity report
- `{{paths.artifacts_root}}` - Artifacts directory

## Development

```bash
cd scripts/workflow
npm install      # Install dependencies
npm run build    # Build TypeScript (tsup)
npm test         # Run tests (vitest)
npm run lint    # Lint code
```

Root `package.json` includes Salesforce DX tooling, Prettier, Husky, and lint-staged for the repo.

## Documentation

- [Configuration](config/shared.json)
- [Copilot Instructions](.github/copilot-instructions.md)
